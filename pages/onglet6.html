<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Version 2.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Bodoni:ital,wght@1,400&family=Playfair+Display:wght@400;700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        #material-selection {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        #material-list {
            margin-top: 20px;
        }
        .material-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #ccc;
            align-items: center;
        }
        .material-item div {
            width: 20%;
            text-align: center;
        }
        .material-item button {
            background-color: red;
            color: white;
            border: none;
            padding: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        #version-display {
            opacity: 0;
            transition: opacity 1s ease;
        }
        .show-version {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header-image">
        <div class="header-overlay">Version 2.2</div>
    </div>

    <header class="menu">
        <div id="menu-container"></div>
        <script>
            fetch('../menu.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('menu-container').innerHTML = data;
                });
        </script>
    </header>

    <main class="content">
        <h1>Sélection de Matériaux et Transport</h1>
        <div id="material-selection">
            <label for="material-dropdown">Choisissez un matériau :</label>
            <select id="material-dropdown" onchange="showCustomDensity()">
                <option value="">Sélectionnez un matériau</option>
            </select>
            <label for="custom-density">Masse volumique (kg/m³) :</label>
            <input type="number" id="custom-density" step="1" min="1">
            <label for="material-weight">Poids (kg) :</label>
            <input type="number" id="material-weight" step="1" min="1">
            <button onclick="addMaterial()">Ajouter</button>
        </div>

        <div id="material-list">
            <div class="material-item" style="font-weight: bold;">
                <div>Matériau</div>
                <div>Masse Volumique (kg/m³)</div>
                <div>Poids (kg)</div>
                <div>Volume (m³)</div>
                <div>Action</div>
            </div>
        </div>
        <div id="vehicle-results"></div>
    </main>

    <script>
        let materialsData = {};
        let vehicleData = [];

        async function loadMaterialsData() {
            try {
                const response = await fetch('../static/json/impactfdvmat.json');
                const data = await response.json();
                data.Feuil1.forEach(material => {
                    const name = material.Matériau;
                    const density = material["Masse Volumique (kg/m³)"];
                    materialsData[name] = density;
                });
                populateDropdown();
            } catch (error) {
                console.error("Erreur lors du chargement des données de matériaux :", error);
            }
        }

        async function loadVehicleData() {
            try {
                const response = await fetch('../static/json/vehiculecarbone.json');
                const data = await response.json();
                vehicleData = data.vehicleClasses;
            } catch (error) {
                console.error("Erreur lors du chargement des données de véhicules :", error);
            }
        }

        function populateDropdown() {
            const materialDropdown = document.getElementById("material-dropdown");
            Object.keys(materialsData).forEach(material => {
                const option = document.createElement("option");
                option.value = material;
                option.textContent = material;
                materialDropdown.appendChild(option);
            });
        }

        function showCustomDensity() {
            const selectedMaterial = document.getElementById("material-dropdown").value;
            const customDensityContainer = document.getElementById("custom-density");
            if (selectedMaterial) {
                const defaultDensity = materialsData[selectedMaterial];
                customDensityContainer.value = defaultDensity;
            }
        }

        function addMaterial() {
            const selectedMaterial = document.getElementById("material-dropdown").value;
            const customDensity = document.getElementById("custom-density").value;
            const weight = document.getElementById("material-weight").value;
            const materialListDiv = document.getElementById("material-list");

            if (!selectedMaterial || !customDensity || !weight) {
                alert("Veuillez remplir tous les champs.");
                return;
            }

            const density = parseFloat(customDensity);
            const weightKg = parseFloat(weight);
            const volume = weightKg / density; // Volume en m³

            const materialItemDiv = document.createElement("div");
            materialItemDiv.classList.add("material-item");
            materialItemDiv.innerHTML = `
                <div>${selectedMaterial}</div>
                <div>${density}</div>
                <div>${weightKg}</div>
                <div>${volume.toFixed(2)}</div>
                <div><button onclick="removeMaterial(this, ${weightKg})">Supprimer</button></div>
            `;
            materialListDiv.appendChild(materialItemDiv);

            calculateVehicles();
        }

        function removeMaterial(button, weightKg) {
            const materialItem = button.parentElement.parentElement;
            materialItem.remove();
            calculateVehicles();
        }

        function calculateVehicles() {
            let totalWeight = 0;
            document.querySelectorAll('#material-list .material-item').forEach(item => {
                const weight = parseFloat(item.children[2].innerText);
                totalWeight += weight;
            });

            let vehicles = [];
            let remainingWeight = totalWeight;
            vehicleData.sort((a, b) => a.maxLoad - b.maxLoad);

            while (remainingWeight > 0) {
                for (let i = vehicleData.length - 1; i >= 0; i--) {
                    if (remainingWeight > vehicleData[i].maxLoad) {
                        vehicles.push(vehicleData[i].class);
                        remainingWeight -= vehicleData[i].maxLoad;
                        break;
                    }
                }
                if (remainingWeight < 400) {
                    vehicles.push(vehicleData[0].class);
                    break;
                }
            }
            document.getElementById('vehicle-results').textContent = `Véhicules proposés : ${vehicles.join(", ")}`;
        }

        window.onload = function() {
            loadMaterialsData();
            loadVehicleData();
        };
    </script>
</body>
</html>
