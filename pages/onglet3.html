<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENSAM x Cartier</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Bodoni:ital,wght@1,400&family=Playfair+Display:wght@400;700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="header-image">
        <div class="header-overlay">ENSAM x Cartier</div>
    </div>

    <header class="menu">
        <div id="menu-container"></div>
        <script>
            fetch('../menu.html')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur réseau lors du chargement du menu.');
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('menu-container').innerHTML = data;
                })
                .catch(error => console.error('Erreur lors du chargement du menu :', error));
        </script>
    </header>

    <main class="content">
        <h1>Données Matériaux Campagne EOY2024, V1.01</h1>
        <p>D'après les données de la campagne EOY 2024, l'histogramme ci-dessous représente l'impact Carbone théorique calculé par la maison Cartier à l'aide de coefficients en kgCO2eq/kg matière.</p>
        <p>Sous cet histogramme, il est possible de sélectionner un pays et d'avoir plus d'informations localement par pays.</p>
        <canvas id="materialsChart" width="800" height="400"></canvas>
        <div>
            <label for="countrySelector">Sélectionnez un pays :</label>
            <select id="countrySelector">
                <option value="Germany">Allemagne</option>
                <option value="France">France</option>
                <option value="Italy">Italie</option>
                <option value="Holland">Pays-Bas</option>
                <option value="Spain">Espagne</option>
                <option value="Switzerland">Suisse</option>
                <option value="UK">Royaume-Uni</option>
                <option value="China">Chine</option>
                <option value="USA">États-Unis</option>
            </select>
        </div>
        <canvas id="pieChartMass" width="400" height="400"></canvas>
        <canvas id="pieChartCO2" width="400" height="400"></canvas>
    </main>

    <div class="footer">
        <p>&copy; 2024/2025 Baptiste Légier, Pierre-Vincent Arcade, Valentin Hyaumet. All rights reserved.</p>
    </div>

    <script>
        let jsonData; // Variable pour stocker les données JSON chargées
        let pieChartMass, pieChartCO2; // Variables pour les graphiques circulaires

        const materialColors = {
            "MDF LIGHT": "#FF6384",
            "RECYCLED CARDBOARD": "#36A2EB",
            "RECYCLED POLYESTER": "#FFCE56",
            "MICROFIBER": "#4BC0C0",
            "ALUMINIUM": "#9966FF",
            "PAPER": "#FF9F40",
            "RECYCLED PMMA": "#C9CBCF",
            "RECYCLED PP": "#E7E9ED",
            "PVA": "#8BC34A",
            "PET": "#00ACC1"
        };

        fetch('../static/json/materials.json')
            .then(response => response.json())
            .then(data => {
                jsonData = data;
                const labels = data.map(item => item["Material Family"]);
                const co2Data = data.map(item => item["Impact CO2 (t CO2e)"]);
                const weightData = data.map(item => item["Material weight (t)"]);

                const ctx = document.getElementById('materialsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Impact CO2 (t CO2e)',
                            data: co2Data,
                            backgroundColor: labels.map(label => materialColors[label] || 'rgba(75, 192, 192, 0.5)'),
                        }, {
                            label: 'Material Weight (t)',
                            data: weightData,
                            backgroundColor: labels.map(label => materialColors[label] || 'rgba(255, 99, 132, 0.5)'),
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                fetch('../static/json/pays_mat_co2.json')
                    .then(response => response.json())
                    .then(countryData => {
                        createPieCharts(document.getElementById('countrySelector').value, countryData);
                    })
                    .catch(error => console.error('Erreur lors du chargement du fichier JSON des pays:', error));
            })
            .catch(error => console.error('Erreur lors du chargement du JSON:', error));

        function getCountryData(country, countryData) {
            return countryData.find(item => item["Country"] === country);
        }

        function createPieCharts(country, countryData) {
            const countryInfo = getCountryData(country, countryData);
            if (!countryInfo) return;

            const labels = Object.keys(countryInfo).slice(1);
            const masses = Object.values(countryInfo).slice(1).map(val => parseFloat(val.replace(",", ".")));
            const totalMass = masses.reduce((acc, val) => acc + val, 0);
            const massPercentages = masses.map(mass => (mass / totalMass) * 100);

            if (pieChartMass) pieChartMass.destroy();
            const ctxMass = document.getElementById('pieChartMass').getContext('2d');
            pieChartMass = new Chart(ctxMass, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: massPercentages,
                        backgroundColor: labels.map(label => materialColors[label] || '#CCCCCC'),
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Pourcentage de masse par matériau' }
                    }
                }
            });
        }

        document.getElementById('countrySelector').addEventListener('change', (event) => {
            const selectedCountry = event.target.value;
            fetch('../static/json/pays_mat_co2.json')
                .then(response => response.json())
                .then(countryData => {
                    createPieCharts(selectedCountry, countryData);
                })
                .catch(error => console.error('Erreur lors du chargement du fichier JSON des pays:', error));
        });
    </script>
</body>
</html>
