<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparaison des lieux de traitement des déchets</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Bodoni:ital,wght@1,400&family=Playfair+Display:wght@400;700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <style>
        #map { height: 400px; width: 100%; margin-top: 20px; }
        .route-section { margin: 30px 0; }
        .input-group { margin-bottom: 10px; }
        .input-container { display: flex; flex-direction: column; margin-bottom: 20px; }
        .button-add { margin-top: 5px; }
    </style>
</head>
<body>
    <main class="content">
        <h1>Comparaison des lieux de traitement des déchets</h1>
        <section class="route-section">
            <h2>Ajouter des lieux de stockage</h2>
            <div id="storage-container" class="input-container">
                <div class="input-group">
                    <input type="text" class="storage-input" placeholder="Entrez une adresse de stockage">
                </div>
                <button class="button-add" onclick="addStorageInput()">Ajouter un autre lieu de stockage</button>
            </div>

            <h2>Ajouter des lieux de traitement</h2>
            <div id="treatment-container" class="input-container">
                <div class="input-group">
                    <input type="text" class="treatment-input" placeholder="Entrez une adresse de traitement">
                    <select class="treatment-option">
                        <option value="recycling">Recyclage</option>
                        <option value="methanation">Méthanisation</option>
                        <option value="incineration">Incinération</option>
                        <option value="landfill">Enfouissement</option>
                    </select>
                </div>
                <button class="button-add" onclick="addTreatmentInput()">Ajouter un autre lieu de traitement</button>
            </div>

            <button onclick="compareRoutes()">Comparer les itinéraires</button>
            <div id="map"></div>
        </section>
    </main>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <script>
        const map = L.map('map').setView([48.8566, 2.3522], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        function addStorageInput() {
            const container = document.getElementById("storage-container");
            const newInput = document.createElement("input");
            newInput.type = "text";
            newInput.className = "storage-input";
            newInput.placeholder = "Entrez une autre adresse de stockage";
            container.insertBefore(newInput, container.querySelector(".button-add"));
        }

        function addTreatmentInput() {
            const container = document.getElementById("treatment-container");
            const inputGroup = document.createElement("div");
            inputGroup.className = "input-group";

            const newInput = document.createElement("input");
            newInput.type = "text";
            newInput.className = "treatment-input";
            newInput.placeholder = "Entrez une autre adresse de traitement";

            const selectOption = document.createElement("select");
            selectOption.className = "treatment-option";
            selectOption.innerHTML = `
                <option value="recycling">Recyclage</option>
                <option value="methanation">Méthanisation</option>
                <option value="incineration">Incinération</option>
                <option value="landfill">Enfouissement</option>
            `;

            inputGroup.appendChild(newInput);
            inputGroup.appendChild(selectOption);
            container.insertBefore(inputGroup, container.querySelector(".button-add"));
        }

        function geocodeAddress(address, callback) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const latLng = [data[0].lat, data[0].lon];
                        callback(latLng);
                    } else {
                        alert("Adresse non trouvée !");
                    }
                });
        }

        function compareRoutes() {
            const storageInputs = document.querySelectorAll(".storage-input");
            const treatmentInputs = document.querySelectorAll(".treatment-input");
            const treatmentOptions = document.querySelectorAll(".treatment-option");

            storageInputs.forEach(storage => {
                const storageAddress = storage.value;
                if (storageAddress) {
                    geocodeAddress(storageAddress, (storageCoords) => {
                        treatmentInputs.forEach((treatment, index) => {
                            const treatmentAddress = treatment.value;
                            const treatmentType = treatmentOptions[index].value;

                            if (treatmentAddress) {
                                geocodeAddress(treatmentAddress, (treatmentCoords) => {
                                    L.Routing.control({
                                        waypoints: [
                                            L.latLng(storageCoords[0], storageCoords[1]),
                                            L.latLng(treatmentCoords[0], treatmentCoords[1])
                                        ],
                                        routeWhileDragging: true,
                                        createMarker: function(i, waypoint, n) {
                                            let label = i === 0 ? "Stockage" : treatmentType;
                                            return L.marker(waypoint.latLng).bindPopup(label);
                                        }
                                    }).addTo(map);
                                });
                            }
                        });
                    });
                }
            });
        }
    </script>
</body>
</html>
