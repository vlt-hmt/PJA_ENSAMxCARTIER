<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onglet 6 - Sélection de Matériaux et Véhicules</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Bodoni:ital,wght@1,400&family=Playfair+Display:wght@400;700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="../script.js" defer></script>
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* Styles personnalisés pour Onglet 6 */
        #material-section, #vehicle-section {
            margin: 20px 0;
        }
        .material-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .material-select {
            flex: 1;
            padding: 8px;
            margin-right: 10px;
        }
        .material-weight {
            width: 150px;
            padding: 8px;
            margin-right: 10px;
        }
        .remove-material {
            background-color: red;
            color: white;
            border: none;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
        }
        #add-material-button, #calculate-button {
            margin-right: 10px;
            padding: 10px 15px;
            cursor: pointer;
        }
        #vehicle-results ul {
            list-style-type: none;
            padding: 0;
        }
        #vehicle-results li {
            background-color: #f4f4f4;
            margin: 5px 0;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="header-image">
        <div class="header-overlay">ENSAM x Cartier</div>
    </div>

    <header class="menu">
        <nav>
            <ul>
                <li><a href="../index.html">Accueil</a></li>
                <li><a href="onglet1.html">Onglet 1</a></li>
                <li><a href="onglet2.html">Onglet 2</a></li>
                <li><a href="onglet3.html">Onglet 3</a></li>
                <li><a href="onglet4.html">Onglet 4</a></li>
                <li><a href="onglet5.html">Onglet 5</a></li>
                <li><a href="onglet6.html" class="active">Onglet 6</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </nav>
    </header>

    <main class="content">
        <h1>Sélection de Matériaux et Véhicules Appropriés</h1>
        <section id="material-section">
            <h2>Ajouter des Matériaux</h2>
            <div id="materials-container">
                <div class="material-group">
                    <select class="material-select">
                        <option value="">Sélectionnez un matériau</option>
                    </select>
                    <input type="number" min="0" step="any" class="material-weight" placeholder="Poids en kg">
                    <button class="remove-material" onclick="removeMaterial(this)">Supprimer</button>
                </div>
            </div>
            <button id="add-material-button" onclick="addMaterial()">Ajouter un autre matériau</button>
            <button id="calculate-button" onclick="calculateVehicles()">Calculer les véhicules appropriés</button>
        </section>

        <section id="vehicle-section">
            <h2>Véhicules Recommandés</h2>
            <div id="vehicle-results"></div>
        </section>
    </main>

    <script>
        // Variables pour stocker les données
        let materialsData = [];
        let vehiclesData = [];

        // Charger les données des matériaux
        fetch('../static/json/impactfdvmat.json')
            .then(response => response.json())
            .then(data => {
                materialsData = data.Feuil1;
                populateMaterialSelects();
            })
            .catch(error => console.error('Erreur lors du chargement des matériaux:', error));

        // Charger les données des véhicules
        fetch('../static/json/vehiculecarbone.json')
            .then(response => response.json())
            .then(data => {
                vehiclesData = data.vehicleClasses;
            })
            .catch(error => console.error('Erreur lors du chargement des véhicules:', error));

        // Fonction pour remplir les sélecteurs de matériaux
        function populateMaterialSelects() {
            const selects = document.querySelectorAll('.material-select');
            selects.forEach(select => {
                materialsData.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material.Matériau;
                    option.textContent = material.Matériau;
                    select.appendChild(option);
                });
            });
        }

        // Fonction pour ajouter un nouveau groupe de matériau
        function addMaterial() {
            const container = document.getElementById('materials-container');
            const materialGroup = document.createElement('div');
            materialGroup.className = 'material-group';

            const select = document.createElement('select');
            select.className = 'material-select';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Sélectionnez un matériau';
            select.appendChild(defaultOption);

            materialsData.forEach(material => {
                const option = document.createElement('option');
                option.value = material.Matériau;
                option.textContent = material.Matériau;
                select.appendChild(option);
            });

            const inputWeight = document.createElement('input');
            inputWeight.type = 'number';
            inputWeight.min = '0';
            inputWeight.step = 'any';
            inputWeight.className = 'material-weight';
            inputWeight.placeholder = 'Poids en kg';

            const removeButton = document.createElement('button');
            removeButton.className = 'remove-material';
            removeButton.textContent = 'Supprimer';
            removeButton.onclick = function() { removeMaterial(removeButton); };

            materialGroup.appendChild(select);
            materialGroup.appendChild(inputWeight);
            materialGroup.appendChild(removeButton);

            container.appendChild(materialGroup);
        }

        // Fonction pour supprimer un groupe de matériau
        function removeMaterial(button) {
            const materialGroup = button.parentElement;
            materialGroup.remove();
        }

        // Fonction pour calculer les véhicules appropriés
        function calculateVehicles() {
            const materialGroups = document.querySelectorAll('.material-group');
            let totalWeight = 0;

            materialGroups.forEach(group => {
                const weightInput = group.querySelector('.material-weight');
                const weight = parseFloat(weightInput.value);
                if (!isNaN(weight)) {
                    totalWeight += weight;
                }
            });

            if (totalWeight === 0) {
                alert('Veuillez entrer le poids pour au moins un matériau.');
                return;
            }

            const vehicleResultsDiv = document.getElementById('vehicle-results');
            vehicleResultsDiv.innerHTML = '';

            // Convert vehicle maxLoads to kg for comparison
            const vehiclesWithMaxLoadKg = vehiclesData.map(vehicle => {
                return {
                    ...vehicle,
                    maxLoadKg: vehicle.maxLoad * 1000
                };
            });

            // Trier les véhicules par charge utile décroissante
            vehiclesWithMaxLoadKg.sort((a, b) => b.maxLoadKg - a.maxLoadKg);

            // Implémentation d'un algorithme de bin-packing simple
            let remainingWeight = totalWeight;
            let vehicleCounts = {};

            while (remainingWeight > 0) {
                let vehicleFound = false;
                for (let vehicle of vehiclesWithMaxLoadKg) {
                    if (vehicle.maxLoadKg >= remainingWeight) {
                        // Si un véhicule peut transporter le poids restant, on l'utilise
                        vehicleCounts[vehicle.class] = (vehicleCounts[vehicle.class] || 0) + 1;
                        remainingWeight -= remainingWeight;
                        vehicleFound = true;
                        break;
                    }
                }
                if (!vehicleFound) {
                    // Si aucun véhicule ne peut transporter le poids restant, on choisit le plus grand possible
                    for (let vehicle of vehiclesWithMaxLoadKg) {
                        if (vehicle.maxLoadKg <= remainingWeight) {
                            vehicleCounts[vehicle.class] = (vehicleCounts[vehicle.class] || 0) + 1;
                            remainingWeight -= vehicle.maxLoadKg;
                            vehicleFound = true;
                            break;
                        }
                    }
                }
                if (!vehicleFound) {
                    // Si le poids restant est inférieur au plus petit véhicule, on utilise le plus petit véhicule
                    const smallestVehicle = vehiclesWithMaxLoadKg[vehiclesWithMaxLoadKg.length - 1];
                    vehicleCounts[smallestVehicle.class] = (vehicleCounts[smallestVehicle.class] || 0) + 1;
                    remainingWeight -= smallestVehicle.maxLoadKg;
                }
            }

            // Afficher les véhicules recommandés
            const resultList = document.createElement('ul');
            for (let [vehicleClass, count] of Object.entries(vehicleCounts)) {
                const vehicle = vehiclesWithMaxLoadKg.find(v => v.class === vehicleClass);
                const listItem = document.createElement('li');
                listItem.textContent = `${count} x ${vehicleClass} (Charge utile maximale: ${vehicle.maxLoad} tonnes)`;
                resultList.appendChild(listItem);
            }
            vehicleResultsDiv.appendChild(resultList);
        }
    </script>
</body>
</html>
